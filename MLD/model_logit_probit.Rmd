---
title: "Lending Mortage Analysis - Modeling"
author: "Marjorie Blanco, Joe Thompson, Haodi Tu"
output:
  html_document: default
  pdf_document: default
subtitle: Exploratory Data Analysis
geometry: left=2cm,right=3cm,top=2cm,bottom=2cm
---

```{r warning=FALSE, message=FALSE, echo=FALSE}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
options(scipen=999)
library(readr)
library(ggplot2)
library(readxl)
library(kableExtra)
library(dplyr)
library(tidyverse)
library(purrr)
library(ggthemes)
library(aod)
library(lmtest)
library(survey)
library(caret)
library(pscl)
library(survey)
library(stargazer)
```


```{r}
# data <- read_excel("MLD/MLD Data File.xls")
```

```{r}
data <- read_excel("MLD Data File.xls")
```

```{r}
#http://people.umass.edu/biep640w/pdf/R-for-Logistic-Regression.pdf
#https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf
#https://www.r-bloggers.com/evaluating-logistic-regression-models/
```

```{r}
data <- data %>% filter(MALE != ".") %>% filter(GDLIN != "666") %>% filter(LOANPRC < 1)
data$LOANPRC <- data$LOANPRC * 100
data$GDLIN <- as.factor(data$GDLIN)
data$MARRIED <- as.factor(data$MARRIED)
data$MALE <- as.factor(data$MALE)
data$APPROVE <- as.factor(data$APPROVE)
data$BLACK <- as.factor(data$BLACK)
data$HISPAN <- as.factor(data$HISPAN)
```


```{r eval=FALSE}
#Descriptive statistics by Race:

stargazer(data %>% filter(BLACK == 0) %>% filter(HISPAN == 0), type = "text", title="Descriptive statistics - non-Hispanic White", digits=2)

stargazer(data %>% filter(BLACK == 1) %>% filter(HISPAN == 0), type = "text", title="Descriptive statistics - non-Hispanic Black", digits=2)

stargazer(data %>% filter(BLACK == 0) %>% filter(HISPAN == 1), type = "text", title="Descriptive statistics - Hispanic", digits=2)
```

```{r}
AVG_LOANPRC <- mean(data$LOANPRC)
AVG_OBRAT <- mean(data$OBRAT)

newdata21 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 192)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(1), HISPAN = factor(0), MARRIED = factor(rep(0:1, each = 96)), LOANPRC = AVG_LOANPRC))
newdata22 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 192)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(0), HISPAN = factor(1), MARRIED = factor(rep(0:1, each = 96)), LOANPRC = AVG_LOANPRC))
newdata23 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 192)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(0), HISPAN = factor(0), MARRIED = factor(rep(0:1, each = 96)), LOANPRC = AVG_LOANPRC))


newdata24 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 200)), OBRAT = AVG_OBRAT, BLACK = factor(1), HISPAN = factor(0), MARRIED = factor(rep(0:1, each = 100)), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))
newdata25 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 200)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(1), MARRIED = factor(rep(0:1, each = 100)), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))
newdata26 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 200)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(0), MARRIED = factor(rep(0:1, each = 100)), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))


newdata31 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 96)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(1), HISPAN = factor(0), LOANPRC = AVG_LOANPRC))
newdata32 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 96)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(0), HISPAN = factor(1), LOANPRC = AVG_LOANPRC))
newdata33 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 96)), OBRAT = rep(seq(from = 0, to = 95, length.out = 96)), BLACK = factor(0), HISPAN = factor(0), LOANPRC = AVG_LOANPRC))


newdata34 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 100)), OBRAT = AVG_OBRAT, BLACK = factor(1), HISPAN = factor(0), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))
newdata35 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 100)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(1), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))
newdata36 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 100)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(0), LOANPRC = rep(seq(from = 2.105, to = 100, length.out = 100))))


newdata41 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 1)), OBRAT = AVG_OBRAT, BLACK = factor(1), HISPAN = factor(0), LOANPRC = AVG_LOANPRC))
newdata42 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 1)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(1), LOANPRC = AVG_LOANPRC))
newdata43 <- with(data, data.frame(GDLIN = factor(rep(0:1, each = 1)), OBRAT = AVG_OBRAT, BLACK = factor(0), HISPAN = factor(0), LOANPRC = AVG_LOANPRC))
```

## Data Discription

The data set includes the following variables: 

+ APPROVE = 1 if mortgage loan was approved, = 0 otherwise
+ GDLIN = 1 if credit history meets guidelines, = 0 otherwise
+ LOANPRC = loan amount/purchase price
+ OBRAT = other obligations as a percent of total income
+ MALE = 1 if male, = 0 otherwise
+ MARRIED = 1 if married, = 0 otherwise
+ BLACK = 1 if black, = 0 otherwise
+ HISPAN = 1 if Hispanic, = 0 otherwise

## Logistic Model

$$log(p/1-p) = \beta_0 + \beta_1 * GDLIN + \beta_2 * OBRAT + \beta_3 * BLACK + \beta_4 * HISPAN + \beta_5 * LOANPRC$$


```{r}
LogitModel <- glm(APPROVE ~  GDLIN + OBRAT + BLACK + HISPAN  + LOANPRC , data = data, family = "binomial")

#Generate Log-Likelihood
logLik(LogitModel)

stargazer(LogitModel,
          type = "text",
          digits = 3,
          header = T,
          title = "Logistic Regression")

OR <- function(x) exp(x)

stargazer(LogitModel, 
          type="text", 
          apply.coef = OR, 
          title = "Odds Ratio")
```



### CIs using profiled log-likelihood

```{r}
confint(LogitModel)
```

### CIs using standard errors

```{r}
confint.default(LogitModel)
```

### Odds ratios only

```{r}
exp(coef(LogitModel))
```

### Odds ratios and 95% CI

```{r}
exp(cbind(OR = coef(LogitModel), confint(LogitModel)))
```

Holding `GDLIN1`, `LOANPRC` and `Race` constant, for every one unit change in `OBRAT`, the log odds of loan approval (versus non loan approval) decreases by `r round(abs(1- exp(LogitModel$coefficients["OBRAT"])),2)*100`%; 95% confidence interval [CI] = 0.95, 0.99.

Holding `GDLIN1`, `OBRAT` and `Race` constant, for every one unit change in `LOANPRC`, the log odds of loan approval (versus non loan approval) decreases by `r round(abs(1- exp(LogitModel$coefficients["LOANPRC"])),2)*100`%; 95% confidence interval [CI] = 0.97, 1.00.

Holding GDLIN1, OBRAT and Race constant, the log odds of loan approval for applicants that meet credit guidelines over the odds of applicants that do not meet credit guidelines is `r round(abs(exp(LogitModel$coefficients["GDLIN1"])),2)`%, 95% confidence interval [CI] = 27.45, 65.50.


```{r}
newdata2 <- rbind(newdata31, newdata32, newdata33)
newdata3 <- cbind(newdata2, predict(LogitModel, newdata = newdata2, type = "link", se = TRUE)[1])
newdata3$PredictedProb <- plogis(newdata3$fit)
  # LL <- plogis(fit - (1.96 * se.fit))
  # UL <- plogis(fit + (1.96 * se.fit))
#})

newdata4 <- rbind(newdata41, newdata42, newdata43)
newdata5 <- cbind(newdata4, predict(LogitModel, newdata = newdata4, type = "link", se = TRUE)[1])
newdata5$PredictedProb <- plogis(newdata5$fit)

# newdata5 <- within(newdata5, {
#   PredictedProb <- plogis(fit)
  # LL <- plogis(fit - (1.96 * se.fit))
  # UL <- plogis(fit + (1.96 * se.fit))
# })

#predict(LogitModel, newdata = newdata5, type = "response", se = TRUE)
```

```{r eval=FALSE}
sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 1, 0, 75.44245)))
sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 1, 0, 75.44245)))
sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 1, 75.44245)))
sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 1, 75.44245)))
sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 0, 75.44245)))
sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 0, 75.44245)))


plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 1, 0, 75.44245))))
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 1, 0, 75.44245))))
plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 1, 75.44245))))
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 1, 75.44245))))
plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 0, 75.44245))))
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 0, 75.44245))))


#check that it adds up to 1
plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 1, 0, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 1, 0, 75.44245))),  lower.tail = FALSE) 
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 1, 0, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 1, 0, 75.44245))),  lower.tail = FALSE)
plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 1, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 1, 75.44245))),  lower.tail = FALSE)
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 1, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 1, 75.44245))),  lower.tail = FALSE)
plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 0, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 0, 75.44245))),  lower.tail = FALSE)
plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 0, 75.44245)))) + plogis(sum(LogitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 0, 75.44245))),  lower.tail = FALSE)
```

```{r}
kable(head(newdata5)) %>%
  kable_styling(bootstrap_options = "striped")
```

The predicted probability of approval for a Black person whose credit history meets guidelines (`GDLIN` = 1), at average other debt obligations related to total income (`OBRAT` = 32.36%) and at average loan amount relative to price of the property (`LOANPRC` = 75.44%) is `r  round(newdata5$PredictedProb[2], 2)*100`%. White person with the same conditions has higher probability to approve, the predicted probability gap is `r  round(newdata5$PredictedProb[6]- newdata5$PredictedProb[2], 2)*100` percentage points. 

The predicted probability gap between White and Hispan people under the same background (credit history met guidelines, OBRAT and LOANPRC at the same rate) is `r  round(newdata5$PredictedProb[6]- newdata5$PredictedProb[4], 2)*100` percentage points.


```{r}
write_csv(newdata3, "logit_OBRAT.csv")

newdata3$RACE <- ifelse(newdata3$BLACK == 1, "non-Hispanic Black", ifelse(newdata3$HISPAN == 1, "Hispanic", "non-Hispanic White"))
newdata3$RACE  <- as.factor(newdata3$RACE)
newdata3$GDLIN <- ifelse(newdata3$GDLIN == 1, "Meets guidelines", "Does not meet guidelines")

ggplot(newdata3, aes(x = OBRAT, y = PredictedProb)) + 
  geom_line(aes(colour = RACE, linetype = RACE), size = 1)  +
  theme(legend.position="bottom") +
  xlab("Other obligations as a percent of total income") +
  ggtitle("Predicted probabilities (LOANPRC = 75.44245%)") + 
  facet_wrap(GDLIN ~ ., scales="free") +
  ylab("PredictedProb") + ylim(c(0,1))
```

The figure above illustrates that the comparison of predicted probability for people with diffierent race when loan price is 75.4% using logit model. When guidelines are not met, gap of predicted probability of approval between White and Hispanic decreases as percentage of other obligations increases, similar with Black. Black and Hispanic have similar predicted probability. On the contrary, gap between White and Hispanic (and Black) increase as percentage of other obligations increases.


```{r}
newdata2 <- rbind(newdata34, newdata35, newdata36)
newdata3 <- cbind(newdata2, predict(LogitModel, newdata = newdata2, type = "link", se = TRUE)[1])
newdata3$PredictedProb <- plogis(newdata3$fit)

# newdata3 <- within(newdata3, {
#   PredictedProb <- plogis(fit)
#   # LL <- plogis(fit - (1.96 * se.fit))
#   # UL <- plogis(fit + (1.96 * se.fit))
# })
```

```{r}
write_csv(newdata3, "logit_LOANPRC.csv")

newdata3$RACE <- ifelse(newdata3$BLACK == 1, "non-Hispanic Black", ifelse(newdata3$HISPAN == 1, "Hispanic", "non-Hispanic White"))
newdata3$RACE  <- as.factor(newdata3$RACE)
newdata3$GDLIN <- ifelse(newdata3$GDLIN == 1, "Meets guidelines", "Does not meet guidelines")

ggplot(newdata3, aes(x = LOANPRC, y = PredictedProb)) + 
  geom_line(aes(colour = RACE, linetype = RACE), size = 1)  +
  theme(legend.position="bottom") +
  xlab("Loan amount/purchase price %") +
  ggtitle("Predicted probabilities (OBRAT = 32.35767)") + 
  facet_wrap(GDLIN ~ ., scales="free") +
  ylab("PredictedProb") + ylim(c(0,1))
```

The figure above illustrates that the comparison of predicted probability for people with diffierent race when other obligation is 32.4% using logit model. Similar patterns with figure 1, except the prodicted probability gap is larger between white and other race (Black and Hispanic) when guidelines are not met, and the gap is smaller when guidelines are met. 



### Probit Model

$$Probit(approve) = \beta_0 + \beta_1 * GDLIN + \beta_2 * OBRAT + \beta_3 * BLACK + \beta_4 * HISPAN + \beta_5 * LOANPRC $$

```{r}
ProbitModel <- glm(APPROVE ~  GDLIN + OBRAT + BLACK + HISPAN + LOANPRC, data = data, family = binomial(link = "probit"))
#summary(ProbitModel)


#Generate Log-Likelihood
logLik(ProbitModel)

stargazer(ProbitModel,
          type = "text",
          digits = 3,
          header = T,
          title = "Probit Regression")
```


For example, for a black person whose credit history meets guidline (GDLIN = 1), loan amount price is 100 (LOANPRC = 100) and other obligations as a percent of total income is none (OBRAT = 0), the predicted probablity of loan approval is `r (round(pnorm(-abs((ProbitModel$coefficients["(Intercept)"] + ProbitModel$coefficients["GDLIN1"] + ProbitModel$coefficients["BLACK1"] + 100 * ProbitModel$coefficients["LOANPRC"]))), 4))*100`%

```{r}
newdata2 <- rbind(newdata31, newdata32, newdata33)
newdata3 <- cbind(newdata2, predict(ProbitModel, newdata2, type = "response", se.fit = TRUE)[1])
write_csv(newdata3, "probit_OBRAT.csv")

newdata4 <- rbind(newdata41, newdata42, newdata43)
newdata6 <- cbind(newdata4, predict(ProbitModel, newdata4, type = "link", se.fit = TRUE)[1], predict(ProbitModel, newdata4, type = "response", se.fit = TRUE)[1])
```

```{r eval=FALSE}
sum(ProbitModel$coefficients * matrix(c(1, 0, 32.35767, 1, 0, 75.44245)))
sum(ProbitModel$coefficients * matrix(c(1, 1, 32.35767, 1, 0, 75.44245)))
sum(ProbitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 1, 75.44245)))
sum(ProbitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 1, 75.44245)))
sum(ProbitModel$coefficients * matrix(c(1, 0, 32.35767, 0, 0, 75.44245)))
sum(ProbitModel$coefficients * matrix(c(1, 1, 32.35767, 0, 0, 75.44245)))
```

```{r}
kable(head(newdata6)) %>%
  kable_styling(bootstrap_options = "striped")
```

The predicted probability of approval for a Black person whose credit history meets guidelines (`GDLIN` = 1), at average other debt obligations related to total income (`OBRAT` = 32.36%) and at average loan amount relative to price of the property (`LOANPRC` = 75.44%) is `r  round(newdata6$PredictedProb[2], 2)*100`%. White person with the same conditions has higher probability to approve, the predicted probability gap is `r  round(newdata6$PredictedProb[6]- newdata6$PredictedProb[2], 2)*100` percentage points. 

The predicted probability gap between White and Hispan people under the same background (credit history met guidelines, OBRAT and LOANPRC at the same rate) is `r  round(newdata6$PredictedProb[6]- newdata6$PredictedProb[4], 2)*100` percentage points.



```{r}
newdata3$RACE <- ifelse(newdata3$BLACK == 1, "non-Hispanic Black", ifelse(newdata3$HISPAN == 1, "Hispanic", "non-Hispanic White"))
newdata3$RACE  <- as.factor(newdata3$RACE)
newdata3$GDLIN <- ifelse(newdata3$GDLIN == 1, "Meets guidelines", "Does not meet guidelines")

ggplot(newdata3, aes(x = OBRAT, y = fit)) + 
  geom_line(aes(colour = RACE, linetype = RACE), size = 1)  +
  theme(legend.position="bottom") +
  xlab("Other obligations as a percent of total income") +
  ggtitle("Predicted probabilities (LOANPRC = 75.44245%)") + 
  facet_wrap(GDLIN ~ ., scales="free") +
  ylab("PredictedProb") + ylim(c(0,1))
```


```{r}
newdata2 <- rbind(newdata34, newdata35, newdata36)
newdata3 <- cbind(newdata2, predict(ProbitModel, newdata2, type = "response", se.fit = TRUE)[1])
write_csv(newdata3, "probit_LOANPRC.csv")
```

```{r}
newdata3$RACE <- ifelse(newdata3$BLACK == 1, "non-Hispanic Black", ifelse(newdata3$HISPAN == 1, "Hispanic", "non-Hispanic White"))
newdata3$RACE  <- as.factor(newdata3$RACE)
newdata3$GDLIN <- ifelse(newdata3$GDLIN == 1, "Meets guidelines", "Does not meet guidelines")

ggplot(newdata3, aes(x = LOANPRC, y = fit)) + 
  geom_line(aes(colour = RACE, linetype = RACE), size = 1)  +
  theme(legend.position="bottom") +
  xlab("Loan amount/purchase price %") +
  ggtitle("Predicted probabilities (OBRAT = 32.35767)") + 
  facet_wrap(GDLIN ~ ., scales="free") +
  ylab("PredictedProb") + ylim(c(0,1))
```

## Probablities Comparison

```{r}
newdata4$LogitProb <- predict(LogitModel, newdata = newdata4, type = "response", se = FALSE)
newdata4$ProbitProb <- predict(ProbitModel, newdata = newdata4, type = "response", se = FALSE)
```

```{r}
kable(newdata4) %>%
  kable_styling(bootstrap_options = "striped")
```